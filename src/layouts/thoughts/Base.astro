---
import "../../styles/global.css";
import { Image } from "astro:assets";
import NavWrapper from "../../components/header/NavWrapper.astro";
import Title from "../../components/structure/Title.astro";
import Footer from "../../components/structure/Footer.astro";
import LoadingBar from "../../components/elements/LoadingBar.astro";
import Breadcrumbs from "../../components/structure/Breadcrumbs.astro";
import ScribbleLoop from "phosphor-astro/ScribbleLoop.astro";
import CommonHead from "../../components/structure/CommonHead.astro";

interface Props {
  pageTitle?: string;
  pageDescription?: string;
  title: string;
  date: string;
  readingTime: number;
  showcase?: string;
  categories?: string[];
}

const {
  pageTitle,
  pageDescription,
  title,
  date,
  readingTime,
  showcase,
  categories = [],
} = Astro.props;

const breadcrumbs = [{ text: "← Back to thoughts", href: "/thoughts" }];

// Format date
const formattedDate = new Date(date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});

const eyelash = `${formattedDate} · ${readingTime} min read`;
---

<!doctype html>
<html lang="en">
  <head>
    <CommonHead
      pageTitle={pageTitle || title}
      pageDescription={pageDescription ||
        `Read ${title} - a blog post about ${categories.join(", ")}`}
    />
  </head>
  <body class="w-full h-screen p-0 m-0 overflow-x-hidden relative">
    <LoadingBar />
    <NavWrapper />

    <header class="w-full relative pt-32">
      <div class="max-w-3xl mx-auto">
        <Breadcrumbs crumbs={breadcrumbs} />
        <Title
          eyelash_text={eyelash}
          title_text={title}
          logo_classes="hidden"
          wrapper_classes="max-3xl:[&.section-wrapper]:px-0 [&>div>*]:!text-left [&>div:last-of-type]:mb-0 [&>div:last-of-type>h3]:text-sm [&>div:last-of-type>h3]:order-2 [&>div:last-of-type>h3]:mb-10 [&>div:last-of-type>div]:hidden"
        >
          <div slot="title-content" class="flex justify-start gap-2 mt-6">
            {
              categories.map((category) => (
                <span class="inline-block px-3 py-1 rounded-full text-sm bg-paper-green text-ink-primary">
                  {category}
                </span>
              ))
            }
          </div>
        </Title>
      </div>
    </header>

    <main class="flex-1 relative">
      <article class="w-full max-w-3xl mx-auto px-10 max-3xl:px-0">
        {
          showcase && (
            <div class="artwork-wrapper content-section">
              <div class="absolute inset-0 w-full h-full flex justify-center items-center gap-2 text-ink-secondary text-center loading-overlay">
                <ScribbleLoop class="w-6 h-6 animate-spin" />
                <span class="animate-pulse">Drawing...</span>
              </div>
              <Image
                src={showcase}
                alt={title}
                width={1200}
                height={630}
                class="w-full h-auto relative z-10 opacity-0 transition-opacity duration-300"
                loading="eager"
                onload="this.style.opacity = '1'; this.previousElementSibling.classList.add('opacity-0', 'pointer-events-none')"
              />
            </div>
          )
        }

        <div class="prose max-w-none content-section">
          <slot />
        </div>
      </article>
    </main>

    <div class="divider--extra-large"></div>
    <Footer showBackToTop={true} />
  </body>
</html>

<script>
  import "../../scripts/controllers/intersection-controller";
</script>

<style>
  .artwork-wrapper {
    @apply relative mb-12 rounded-lg overflow-hidden bg-stone-100;
  }

  .prose {
    @apply font-safiro
      prose-headings:text-ink-primary
      prose-h2:font-medium
      prose-h2:text-3xl
      prose-h2:[&:not(:first-of-type)]:mt-16
      prose-h2:[&:not(:last-of-type)]:mb-6
      prose-h4:font-medium
      prose-p:text-ink-secondary
      prose-p:leading-relaxed
      prose-a:text-orange-600 
      prose-a:no-underline 
      hover:prose-a:underline
      prose-blockquote:border-l-4
      prose-blockquote:border-stone-300
      prose-blockquote:pl-4
      prose-blockquote:italic
      prose-ul:list-disc
      prose-ul:ml-6
      prose-li:text-ink-secondary
      prose-img:rounded-lg;
  }

  /* Notion-specific styles */
  .prose :global(.callout) {
    @apply p-4 rounded-lg flex gap-3 my-6 bg-paper-green;
  }

  .prose :global(.video-wrapper) {
    @apply relative w-full my-6 aspect-video;
  }

  .prose :global(.video-wrapper iframe) {
    @apply absolute inset-0 w-full h-full rounded-lg;
  }

  .loading-overlay {
    transition: opacity 0.3s ease-out;
  }

  /* Ensure the image transition works */
  .artwork-wrapper img {
    transition: opacity 0.3s ease-out;
  }
</style>
