---
// Component Imports
import Layout from "../layouts/Layout.astro";
import Header from "../components/structure/Header.astro";
import GridContainer from "../components/structure/GridContainer.astro";
import ListItem from "../components/elements/ListItem.astro";
import ListItemHeader from "../components/elements/ListItemHeader.astro";

// Data Fetching
import { getThoughts } from "../lib/notion";
import type { ThoughtPost } from "../lib/notion";
import { getCollection, type CollectionEntry } from "astro:content";

// Fetch Notebooks (Content Collection)
const contentPosts = await getCollection("notebooks");
const sideNotes = contentPosts;

// Fetch and Filter Notion Posts
const notionPosts = await getThoughts();
const mainPosts = notionPosts.filter(
  (post: ThoughtPost) => !post.categories.includes("Briefs"),
);

// Group Posts by Year
const years = [
  ...new Set(mainPosts.map((post) => new Date(post.date).getFullYear())),
].sort((a, b) => b - a);

// Helper Functions
const getPostsForYear = (year: number) =>
  mainPosts.filter((post) => new Date(post.date).getFullYear() === year);

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    month: "2-digit",
    day: "2-digit",
  });
};
---

<Layout
  pageTitle="Thoughts - Karina Tovar"
  pageDescription="Mental Notes and Deep Thoughts"
>
  {/* Page Header */}
  <Header
    type="grid"
    size="small"
    title="Notes & Deep Thoughts"
    subtitle="Diary of a pixel philosopher"
    description="This is where I keep my thoughts and ideas. I write about design, technology, and human happiness."
  />

  {/* Notebooks Section */}
  <GridContainer id="notebooks" size="small" spacing="lg">
    <h3 class="mt-0 mb-5 text-5xl font-medium opacity-50">Notebooks</h3>
    <div class="writing-list">
      {
        sideNotes.map((post) => (
          <ListItem
            icon={false}
            isLink={true}
            label={post.data.title}
            detail={new Date().getFullYear().toString()}
            href={`/notebooks/${post.slug}`}
            iconWidth={12}
            iconHeight={12}
          />
        ))
      }
    </div>
  </GridContainer>

  {/* Yearly Posts Sections */}
  {
    years.map((year) => {
      const postsForYear = getPostsForYear(year);
      return (
        <GridContainer id={`year-${year}`} size="small" spacing="lg">
          <h3 class="mt-0 mb-5 text-5xl font-medium opacity-50">{year}</h3>
          <ListItemHeader leftLabel="TITLE" rightLabel="DATE" />
          <div class="writing-list">
            {postsForYear.map((post) => (
              <ListItem
                icon={false}
                isLink={true}
                label={post.title}
                detail={formatDate(post.date)}
                href={post.href}
                iconWidth={10}
                iconHeight={10}
              />
            ))}
          </div>
        </GridContainer>
      );
    })
  }
</Layout>

<style>
  .writing-list {
    @apply space-y-3 mt-2 relative w-full;
  }
</style>
